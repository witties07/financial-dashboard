<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Data Visualization</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            height: 60vh;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Financial Data Dashboard</h1>
            <p class="text-gray-600 mt-2">Upload your Excel file to visualize monthly financial data.</p>
        </header>

        <main>
            <!-- Upload Section -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-semibold mb-4">Upload Financial Data</h2>
                <form id="uploadForm" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="userId" class="block text-sm font-medium text-gray-700">User</label>
                        <select id="userId" name="userId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                            <option value="1">Jane Doe</option>
                            <option value="2">John Smith</option>
                        </select>
                    </div>
                    <div>
                        <label for="year" class="block text-sm font-medium text-gray-700">Year</label>
                        <input type="number" id="year" name="year" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., 2023" required>
                    </div>
                    <div>
                        <label for="file" class="block text-sm font-medium text-gray-700">Excel File (.xlsx)</label>
                        <input type="file" id="file" name="file" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100" accept=".xlsx" required>
                    </div>
                    <div class="md:col-span-3 text-center mt-4">
                        <button type="submit" class="w-full md:w-auto inline-flex justify-center py-2 px-8 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Upload & Visualize
                        </button>
                    </div>
                </form>
                <div id="statusMessage" class="mt-4 text-center"></div>
            </div>

            <!-- Data Display Section -->
            <div id="dataDisplay" class="hidden">
                 <div class="text-center mb-8">
                    <h2 class="text-2xl font-semibold">Financial Report for <span id="reportUser" class="text-indigo-600"></span> - <span id="reportYear" class="text-indigo-600"></span></h2>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Table -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Data Table</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Month</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="recordsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Chart -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Monthly Breakdown</h3>
                        <div class="chart-container">
                             <canvas id="financialChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const uploadForm = document.getElementById('uploadForm');
        const statusMessage = document.getElementById('statusMessage');
        const dataDisplay = document.getElementById('dataDisplay');
        const reportUser = document.getElementById('reportUser');
        const reportYear = document.getElementById('reportYear');
        const recordsTableBody = document.getElementById('recordsTableBody');
        const financialChartCanvas = document.getElementById('financialChart');
        let myChart;

        // Populate year dropdown
        (function() {
            const yearInput = document.getElementById('year');
            const currentYear = new Date().getFullYear();
            yearInput.value = currentYear;
            yearInput.max = currentYear + 10;
            yearInput.min = currentYear - 50;
        })();


        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            statusMessage.textContent = 'Uploading and processing...';
            statusMessage.className = 'text-blue-600';
            dataDisplay.classList.add('hidden');

            const formData = new FormData(uploadForm);
            const userId = formData.get('userId');
            const year = formData.get('year');
            const file = formData.get('file');

            if (!userId || !year || !file || file.size === 0) {
                statusMessage.textContent = 'Please select a user, year, and a file.';
                statusMessage.className = 'text-red-600';
                return;
            }

            try {
                // NOTE: Replace with your actual backend API URL
                const uploadResponse = await fetch(`/api/finances/upload/${userId}/${year}`, {
                    method: 'POST',
                    body: formData,
                });

                const result = await uploadResponse.json();

                if (!uploadResponse.ok) {
                    throw new Error(result.message || 'File upload failed.');
                }

                statusMessage.textContent = result.message;
                statusMessage.className = 'text-green-600';

                // Fetch and display data after successful upload
                fetchAndDisplayData(userId, year);

            } catch (error) {
                console.error('Error:', error);
                statusMessage.textContent = `Error: ${error.message}`;
                statusMessage.className = 'text-red-600';
            }
        });

        async function fetchAndDisplayData(userId, year) {
            try {
                // NOTE: Replace with your actual backend API URL
                const response = await fetch(`/api/finances/${userId}/${year}`);
                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.message || `Could not fetch data for user ${userId} in ${year}.`);
                }
                const records = await response.json();
                
                const userName = document.getElementById('userId').options[document.getElementById('userId').selectedIndex].text;

                displayData(userName, year, records);

            } catch (error) {
                 console.error('Fetching data error:', error);
                 statusMessage.textContent = `Error: ${error.message}`;
                 statusMessage.className = 'text-red-600';
                 dataDisplay.classList.add('hidden');
            }
        }

        function displayData(userName, year, records) {
            reportUser.textContent = userName;
            reportYear.textContent = year;

            // Populate table
            recordsTableBody.innerHTML = '';
            if (records.length === 0) {
                 recordsTableBody.innerHTML = '<tr><td colspan="2" class="text-center p-4">No data available.</td></tr>';
            } else {
                // Sort records by month for correct chart order
                const monthOrder = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                records.sort((a, b) => monthOrder.indexOf(a.month) - monthOrder.indexOf(b.month));

                records.forEach(record => {
                    const row = `<tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.month}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(record.amount)}</td>
                    </tr>`;
                    recordsTableBody.innerHTML += row;
                });
            }

            // Create/update chart
            const chartLabels = records.map(r => r.month);
            const chartData = records.map(r => r.amount);

            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(financialChartCanvas, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Amount',
                        data: chartData,
                        backgroundColor: 'rgba(79, 70, 229, 0.8)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value, index, values) {
                                    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', notation: 'compact' }).format(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false,
                        },
                        tooltip: {
                             callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            dataDisplay.classList.remove('hidden');
        }
    </script>
</body>
</html>
